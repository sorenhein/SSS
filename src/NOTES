2022-01-03
----------
Working on CombTest errors.

1. Finding the completion card (higher card with partner) in Ranks
2. Each Strategy or even each Result may have an explicit winner
   for which it is valid.
   - Step 1 would be to introduce and keep this Strategy-level
     winner updated

--------

8/1718, AJT / Q9 missing K87
8/1726, AJT / Q7 missing K98
8/1774, AJ8 / Q7 missing KT9

1718 has 6 strategies and refers to 1726 and 1774, not to itself.
1726 refers to itself and to 1774.

1726 actually has the identical (except for a shift) 6 strategies.

1774 has four strategies. Two of them are similar as in 1718,
but with fewer tricks (#1, #2).  They get discarded when expanded
and added.

One of them (#3) is the same as #4 in 1718.

The problem is #2 which is similar to 1718 #3, but for d = 5 (Kxx/void)
the original (1718) yields 2, 3NS and this one yields 2, 3N.
The reason is that it's possible to start with the ace and if East is
void, to drop the queen and to lead to the jack.  In a way this is
cheating, as the queen was there.  Maybe if there is no directly higher
card, but there was one, at least take that?

Also, in 1718 why can't we play the ace dropping the queen?  Or the
queen always playing the ace?  Because we can't lead the ace!
The rule in setPlaysSide prevents it: We would lead a card that's higher
than partner's best one.  Now we can, but that makes even more options.
Some of them should go away, reducing to four strategies in this case.

--------

7/1595, KT9 / Q missing AJ8
There is a second strategy starting Q J K, otherwise Q ? 9.
This leads to the same #tricks and a different rank profile,
losing against d = 2 (J / A8) and d = 4 (J8 / A) needing the T, and
winning against d = 6 (AJ / 8) needing only the K no matter what.

This has two minimals, 7/1611 K98 / Q, and 7/1599 KT8 / Q.
7/1611 only has one strategy which is the same as in 7/1595
when ducking the queen.
7/1599 also only has one strategy.  We get to the point of Q J K:
d = 2: 2, 3N
    4: 2, 3N
    6: 2, 5N
    7: 1, 5N

The problem is that for d = 7 it now costs a trick to overtake the
queen, leaving K8 missing A9.  West should never play the jack from
AJ8 as it costs a trick.  

Probably the only real solution is to compare strategies not
primary-secondary but holistically.  Do I want to make that change?
There are many other cases where this would go too far.

Or rather, shouldn't 1595 need the 9 in some variations?  Against
d = 7 (AJ8) we can only afford Q J K because we have the T 9.




1. Ranks skips interesting plays
2. There is minimal, mixed and non-minimal.
   Mixed should include itself in the comparison
3. Ranks: If NS" and N"S, also N'S' and nothing else, etc.
   Check method in Ranks based on the list of lowest strategies winners.
4. Think about down-shifting, e.g. AQ/K missing HH.  If A then Q,
   is the K relevant or is it, too, down-shifted to an x?

WARN-NONMIN      342
ERROR          40490

MINIMUM MATCH 122758
MISMATCH        3161

2. Declarer might get a minAbsNumber() and maxAbsNumber(), then
   setPlaysSide:
   ...
   if // (control.runRankComparisons())
   {
     if (leader.maxAbsNumber() < partner.minAbsNumber())
       return;
   }

   Similarly for 6/502 perhaps, leading the 9 and never the J
   from KQ/J9.  So actually in the above, only the lowest of
   such cards.



2021-12-28
----------
Major next blocks:
5. Continue partitioning of ace-high
   - Non-canonical (not "greater") -> the canonical version
   - Canonical may be completely non-minimal, so probably only
     has 1 minimal?
   - Canonical may be mixed, but then no reason to look at
     minimals?  Might as well solve it since we have to anyway
   - Canonical may be completely minimal


2021-12-27
----------
Maybe each Strategy gets a minimal CombReference, h3 == 0 if not set.
When outputting Strategies, no Prod, but instead h3.
So show the minimal on a per-strategy basis in the table itself.


2021-12-24
----------
10/43051, QT6 / K9875 (for example), missing AJ
We get 3NS for d=0, 3N for d=3 which corresponds to leading to the Q.
We could also lead to the K and get 3N / 3NS.  Is the play left out
of Ranks?

Cleanup:
Comb counts from Combinations to class/struct?
Declarer: greater?
No Winners at all, once there's only ever 1?
Card: When use number, when absNumber?


2021-12-05
----------
Some additional optimizations with numbers, not ranks (xls)
See how many total plays are made now


2021-10-25
----------

CombTest,checkReductions: Should now not need reduceByTricks.
Just use strategies.

2. equalByMethod
   Divide completely by size
   assert size(v1) >= size(v2)?


Open issues 2021-09-26
----------------------
Look at speeding up Slist::equalByMethod.

6. For void starting with 10-13 cards (assuming we solve up to 13
   cards), it's always OK to symmetrize, as we can never get there
   from non-void combinations.  We do this:
   a. If we get above [100] strategies, we start over and only
      look up symmetrized strategies (so 6-8 and 8-6 are done together
      and symmetrized against each other).  Multiply strategy by
      strategy, I think, and don't do a complete cross
   b. In the end, if we are above [16] strategies, we symmetrize
   c. If we know from lookup that something must be symmetric

7. Go from only batch to solving a single distribution from scratch
   a. Basic idea is to make a list of the nodes you'll need
   b. Then make these recursively before you solve this node
   c. A lot of flags are the same, i.e. ranks or not, optimizations
      turned on or not, debugging/checks on/off
   d. Could switch to the minimal one (or one of them) and only
      solve this

A histogram of #strategies shows that we also get large numbers
when South has a single card, e.g. 11/132887, KJ95 / 7 missing AQT864.
Maybe it's OK to limit next strategies to symmetric ones, too,
when South becomes void and there are a lot of next strategies.

Symmetrize 11 / 132902, KJ96 / void: From 132,902 to 166 strategies.
Less than half the square root.


Reduction
---------
* 9: 14762 (KJ97 missing 5 cards) needs 68 distributions

-d
  - Optimize the code for minimal()
  - Also optimize for Strategies == even though it doesn't matter
    - Start at ==, only do upper triangle of matrix


Checks
------
* Node optimization (on/off)
* Strategies *= optimization (on/off)

Check speed and identity of results


Ranks stored in tables
----------------------
* Write and read binary files with holdings to run vs. not
* Is it true that a minimal combination does not need non-minimal
  ones to solve?  If not, we would either solve the non-minimal
  ones, or look up the non-minimal one (probably better) and
  map the smaller number of distributions to the current case somehow


Limited Plays considered
------------------------
* Shift something in Plays or Ranks such that the card number
  starts from 1, not 0, so is distinguishable in Nodes from void
  - I think this involves switching to fullFlag in Play.h, and then
  - samePartial will make different comparisons, but
  - then void == 0 and lowest == 1, otherwise we get aliasing

* Divide Ranks optimizations into those that always make sense, and
  those that only make sense when we don't care about winners.
* Can maybe parametrize Player by full/rank-only loop.  Only needed
  for North and South.
* Can maybe parametrize the Ranks optimizations in the same way.

Make a version of Ranks::setPlays with fewer optimizations:
- Don't have to save partner's cards of equal rank
- When equal rank, all depth combinations

Play eliminations, based on KJ975 missing AQT8xx, so
whenever partner is void:

* In fourth hand where LHO is void, always win cheaply or play lowest
  if you can't win
* In second hand when RHO will show up as void, ditto

Also when we have AQT8 / 64 missing KJ9753, we know that 64 are lower
and shorter than all North cards, so their ranks can't matter.
- Can simplify manually: AQT8 / 64 missing KJ9753.  We can never
  take a rank trick < 8. |S| <= |N|.  Max S <= Max N.  But this only
  gets some of the tough ones.

* Actual optimizations that are probably missing today
- With AQ / - missing KJ, on Ace never drop King (partner will show
  out and the lead was the top card)
- With KJ / - missing AQ, on K never play Q (partner HAS shown out,
  so always win trick)
- Maybe in 4th hand when NS are down to <= 1 card after this trick,
  KJ with AQxx outstanding for example (6/548).

8/1773: Leading the 7 is conceivable(?), but the 8?
Actually with the stiff queen, shouldn't we just lead it?

Winning NS plays in semantic form
---------------------------------
* Winning plays/strategies such as "cash ace"
  - Sometimes NS have several ways to reach its optimum; keep them all
* Noting the inequalities on EW plays that are needed to stabilize
  an NS strategy


Applying constraints to defensive holdings
------------------------------------------
* Distribution::limit, using a struct that Control returns
  - We will fail for now on some HCP values


Bug / behavior?
---------------
Why doesn't it work in Combination to make complete copies of
everything?  It must be some stray pointers, but where?

Mixed strategies
----------------
In the end we may not have to do so much LP.  EW must find play for
each distribution that work against all NS strategies.  EW get into
trouble when they need to vary their play depending on what NS do.
So we keep track of all plays that work in various situations, and we
take the intersection which is often not empty.

I'm hoping this will also give rise to the mandatory falsecards that
protect not this holding, but some other holding.

Perhaps represent all the NS strategies as some kind of tree with the
branching points that they will actually make use of.

In the end there will be the combinations with mixed potential.  But
I think we can do all the above independent of external constraints.
So we can actually tell in the abstract which combinations have the
potential for mixed strategies, even without knowing the constraints?!


TODO
----
Not all features of Control.cpp are implemented yet

No / limited endl

In Card, can we think of a way to avoid depth?  Probably not, 
as it is useful for the output.  Maybe avoid number then? Or name?
